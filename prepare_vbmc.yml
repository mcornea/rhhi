---
- name: Get overcloud nodes
  set_fact:
    oc_nodes: "{{ groups.get('overcloud_nodes', []) }}"

- include_role:
    name: vbmc
  vars:
    vbmc_nodes: "{{ oc_nodes }}"

- name: setup vbmc access for all the available overcloud nodes
  include_role:
    name: vbmc
    tasks_from: iptables_overcloud.yml

- name: get information about vm's from hypervisor
  vars:
    vm_nodes: "{{ oc_nodes }}"
  delegate_to: hypervisor
  shell: |
    NODE_XML=`virsh dumpxml {{ item }}`
    disks_list="["
    for dsk in $(virsh domblklist {{ item }} | tail -n +3 | awk '{print $1}'); do
        disks_list="${disks_list}\"${dsk}\","
    done
    disks_list="${disks_list}]"
    disks_list="$(echo ${disks_list} | sed 's/,]/]/g')"

    echo "{
        'name': '{{ item }}',
        'arch': '`echo "$NODE_XML" | grep arch | cut -d\' -f2`',
        'memory_kibs': '`echo "$NODE_XML" | grep currentMemory | cut -d\< -f2 | cut -d\> -f2`',
        'mac': '`echo "$NODE_XML" | grep data -B 1 | grep mac | cut -d\' -f2`',
        'cpu': '`echo "$NODE_XML" | grep vcpu | cut -d\< -f2 | cut -d\> -f2`',
        'disk_bytes': '`virsh domblkinfo {{ item }} vda | grep -e Capacity | cut -d\: -f2 | xargs`',
        'disks': '${disks_list}',
    }"
  with_items: "{{ vm_nodes|sort }}"
  register: nodes_info
  tags:
    - skip_ansible_lint

- name: generate nodes.json file
  delegate_to: rhhi-client-0
  template:
    src: nodes.json.j2
    dest: /root/nodes.json
